<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 Mexicanos Dijeron - Edici√≥n Final Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ce1126">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <style>
        /* (Se mantienen tus estilos originales) */
        :root { --verde: #006847; --rojo: #ce1126; --azul: #0056b3; --oro: #ffeb3b; --gris: #333; }
        body { font-family: 'Arial Black', sans-serif; background: #050505; color: white; text-align: center; margin: 0; padding: 15px; overflow-x: hidden; }
        .main-frame { max-width: 850px; margin: auto; padding: 20px; border: 10px solid #222; border-radius: 40px; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); position: relative; border: 5px solid #333; }
        #btn-config-toggle { position: absolute; top: 15px; right: 20px; background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; padding: 10px; border-radius: 50%; cursor: pointer; display: none; z-index: 100; transition: 0.3s; }
        .round-counter { color: var(--oro); font-size: 1.1em; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; background: rgba(255,235,59,0.1); display: inline-block; padding: 5px 20px; border-radius: 20px; border: 1px solid rgba(255,235,59,0.3); }
        .upload-section { background: #1a1a1a; padding: 15px; border-radius: 15px; margin-top: 15px; border: 1px solid #444; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; }
        .upload-group { display: flex; flex-direction: column; font-size: 0.7em; position: relative; }
        .upload-group label { color: var(--oro); margin-bottom: 3px; font-weight: bold; }
        .loaded-mark { display: none; color: #0f0; font-weight: bold; position: absolute; right: 5px; top: 18px; }
        .volume-control { grid-column: span 2; background: #252525; padding: 10px; border-radius: 10px; display: flex; align-items: center; gap: 15px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .timer { font-size: 3em; color: var(--oro); background: #111; padding: 10px 25px; border-radius: 15px; border: 3px solid var(--oro); min-width: 80px; }
        .score-box { width: 30%; padding: 10px; border: 5px solid var(--gris); border-radius: 20px; opacity: 0.2; transition: 0.4s; }
        .score-box.active { opacity: 1; transform: scale(1.05); }
        #p1-box.active { border-color: var(--azul); box-shadow: 0 0 20px var(--azul); }
        #p2-box.active { border-color: var(--rojo); box-shadow: 0 0 20px var(--rojo); }
        .score-val { font-size: 3em; color: var(--oro); font-family: 'Courier New', monospace; letter-spacing: -4px; }
        .board { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .answer { background: #111; height: 55px; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; font-size: 1.3em; border-radius: 10px; cursor: pointer; border-left: 10px solid var(--gris); transition: 0.3s; }
        .hidden span, .hidden strong { display: none; }
        .hidden::after { content: "‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè"; color: #333; margin: auto; }
        .revealed { border-left-color: var(--oro); background: #222; transform: rotateX(360deg); transition: 0.6s; }
        .x-mark { font-size: 4em; color: #151515; margin: 0 8px; font-weight: bold; }
        .x-active { color: var(--rojo); text-shadow: 0 0 20px red; }
        #coin-setup { background: #222; padding: 20px; border-radius: 20px; border: 2px solid var(--oro); margin-top: 15px; }
        .coin-btn { background: #444; color: white; border: 2px solid #666; padding: 10px 20px; cursor: pointer; border-radius: 10px; margin: 5px; font-size: 1.2em; transition: 0.3s; }
        #coin-result { font-size: 2em; color: var(--oro); margin: 15px 0; height: 40px; }
        .team-select-btn { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; width: 45%; margin: 5px; }
        #winner-screen { display: none; position: fixed; inset: 0; background: radial-gradient(circle, #222 0%, #000 100%); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .win-banner { font-size: 5em; margin: 0; color: white; text-shadow: 0 0 20px gold; animation: scaleUp 0.8s infinite alternate ease-in-out; }
        @keyframes scaleUp { from { transform: scale(1); } to { transform: scale(1.1); } }
        button { padding: 15px; cursor: pointer; font-weight: bold; border: none; border-radius: 12px; text-transform: uppercase; font-size: 1em; }
        .btn-err { background: linear-gradient(to bottom, #ff4d4d, #ce1126); color: white; width: 100%; box-shadow: 0 5px 0 #800; }
        #setup-panel { background: #111; padding: 20px; border-radius: 20px; margin-top: 15px; border: 1px solid #444; }
        textarea { width: 100%; height: 100px; background: #000; color: #0f0; margin-bottom: 10px; font-family: monospace; padding: 10px; box-sizing: border-box; }
        .save-btn { background: #444; color: white; width: 100%; margin-bottom: 10px; border: 1px solid var(--oro); }
    </style>
</head>
<body onload="initApp()">

<audio id="snd-intro"></audio>
<audio id="snd-bg" loop></audio>
<audio id="snd-correct"></audio>
<audio id="snd-wrong"></audio>
<audio id="snd-tick"></audio>
<audio id="snd-endround"></audio>
<audio id="snd-win"></audio>

<div id="winner-screen">
    <h1 id="winner-team-name" class="win-banner">¬°EQUIPO AZUL!</h1>
    <div id="final-score" style="font-size: 4em; color: white; margin: 20px 0;">000 PTS</div>
    <button onclick="location.reload()" style="background: var(--verde); color: white; padding: 20px 50px; font-size: 1.5em;">REINICIAR TODO</button>
</div>

<div class="main-frame">
    <button id="btn-config-toggle" onclick="toggleConfig()">‚öôÔ∏è</button>

    <div class="header">
        <div id="p1-box" class="score-box active">
            <div style="color:#4aa3ff; font-size:0.8em;">EQUIPO AZUL</div>
            <div id="score-0" class="score-val">000</div>
        </div>
        <div id="timer-val" class="timer">20</div>
        <div id="p2-box" class="score-box">
            <div style="color:#ff4d4d; font-size:0.8em;">EQUIPO ROJO</div>
            <div id="score-1" class="score-val">000</div>
        </div>
    </div>

    <div id="round-number" class="round-counter">CONFIGURACI√ìN</div>
    <h2 id="q-display" style="margin: 8px 0; font-size: 1.4em;">LISTO PARA COMENZAR</h2>
    
    <div id="coin-setup" style="display:none;">
        <h3>SORTEO INICIAL</h3>
        <button class="coin-btn" onclick="tossCoin()">LANZAR MONEDA ü™ô</button>
        <div id="coin-result">?</div>
        <hr style="border-color:#444; margin: 20px 0;">
        <p>ELEGIR QUI√âN EMPIEZA:</p>
        <button class="team-select-btn" style="background:var(--azul); color:white;" onclick="setStartingTeam(0)">EQUIPO AZUL</button>
        <button class="team-select-btn" style="background:var(--rojo); color:white;" onclick="setStartingTeam(1)">EQUIPO ROJO</button>
    </div>

    <div id="board" class="board"></div>

    <div id="x-container" style="margin-bottom: 15px;">
        <span class="x-mark">X</span><span class="x-mark">X</span><span class="x-mark">X</span>
    </div>

    <button id="btn-error" class="btn-err" onclick="handleError()" style="display:none;">¬°ERROR!</button>
    <button id="next-btn" onclick="nextRound()" style="display:none; background:var(--azul); color:white; width:100%; margin-top:10px;">SIGUIENTE RONDA ‚Üí</button>

    <div id="setup-panel">
        <button class="save-btn" onclick="saveTextAndVol()">üíæ GUARDAR PREGUNTAS Y VOLUMEN</button>
        
        <textarea id="input-data">¬øAlgo que un mexicano le pone a todo?
Lim√≥n,45
Salsa,30
Sal,15
Chile,10

¬øCosa que haces nada m√°s despertar?
Ver el celular,50
Ir al ba√±o,25
Ba√±arse,15
Estirarse,10</textarea>
        
        <div class="upload-section">
            <div class="upload-group"><label>1. Intro:</label><input type="file" id="file-snd-intro" accept="audio/*" onchange="loadAudio(this, 'snd-intro')"><span class="loaded-mark">‚úì</span></div>
            <div class="upload-group"><label>2. Fondo:</label><input type="file" id="file-snd-bg" accept="audio/*" onchange="loadAudio(this, 'snd-bg')"><span class="loaded-mark">‚úì</span></div>
            <div class="upload-group"><label>3. Tic-Tac:</label><input type="file" id="file-snd-tick" accept="audio/*" onchange="loadAudio(this, 'snd-tick')"><span class="loaded-mark">‚úì</span></div>
            <div class="upload-group"><label>4. Correcto:</label><input type="file" id="file-snd-correct" accept="audio/*" onchange="loadAudio(this, 'snd-correct')"><span class="loaded-mark">‚úì</span></div>
            <div class="upload-group"><label>5. Error:</label><input type="file" id="file-snd-wrong" accept="audio/*" onchange="loadAudio(this, 'snd-wrong')"><span class="loaded-mark">‚úì</span></div>
            <div class="upload-group"><label>6. Fin Ronda:</label><input type="file" id="file-snd-endround" accept="audio/*" onchange="loadAudio(this, 'snd-endround')"><span class="loaded-mark">‚úì</span></div>
            <div class="upload-group" style="grid-column: span 2;"><label>7. Ganador:</label><input type="file" id="file-snd-win" accept="audio/*" onchange="loadAudio(this, 'snd-win')"><span class="loaded-mark">‚úì</span></div>
            
            <div class="volume-control">
                <label style="color:white; font-size:0.8em;">Volumen: <span id="vol-pct">30%</span></label>
                <input type="range" id="bg-volume" min="0" max="1" step="0.05" value="0.3" oninput="updateVolume(this.value)">
            </div>
        </div>
        <button onclick="showCoinToss()" style="width:100%; background:var(--verde); color:white; margin-top: 15px; font-size: 1.2em;">¬°CONFIGURACI√ìN LISTA!</button>
    </div>
</div>

<script>
    let game = [], round = 0, currentP = 0, errors = 0, points = [0, 0], timerObj;
    let db;

    // Registro del Service Worker para PWA (Hacerlo instalable)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('Error registro SW', err));
        });
    }

    // --- SISTEMA DE ALMACENAMIENTO DE AUDIOS (IndexedDB) ---
    function initApp() {
        const request = indexedDB.open("MexicanosDB", 1);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            db.createObjectStore("sounds", { keyPath: "id" });
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            loadSavedAudios();
        };

        const savedData = localStorage.getItem('mexicanos_data');
        const savedVol = localStorage.getItem('mexicanos_vol');
        if (savedData) document.getElementById('input-data').value = savedData;
        if (savedVol) {
            document.getElementById('bg-volume').value = savedVol;
            updateVolume(savedVol);
        }
    }

    function saveTextAndVol() {
        localStorage.setItem('mexicanos_data', document.getElementById('input-data').value);
        localStorage.setItem('mexicanos_vol', document.getElementById('bg-volume').value);
        alert("¬°Textos y volumen guardados!");
    }

    function loadAudio(input, audioId) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                const transaction = db.transaction(["sounds"], "readwrite");
                transaction.objectStore("sounds").put({ id: audioId, data: base64 });
                document.getElementById(audioId).src = base64;
                input.parentElement.querySelector('.loaded-mark').style.display = 'inline';
            };
            reader.readAsDataURL(file);
        }
    }

    function loadSavedAudios() {
        const transaction = db.transaction(["sounds"], "readonly");
        const store = transaction.objectStore("sounds");
        const request = store.getAll();
        request.onsuccess = () => {
            request.result.forEach(item => {
                const audio = document.getElementById(item.id);
                if (audio) {
                    audio.src = item.data;
                    const inputEl = document.getElementById('file-' + item.id);
                    if (inputEl) inputEl.parentElement.querySelector('.loaded-mark').style.display = 'inline';
                }
            });
        };
    }

    function updateVolume(val) {
        const bg = document.getElementById('snd-bg');
        if(bg) bg.volume = val;
        document.getElementById('vol-pct').innerText = Math.round(val * 100) + "%";
    }

    function showCoinToss() {
        document.getElementById('setup-panel').style.display = 'none';
        document.getElementById('coin-setup').style.display = 'block';
        playSnd('snd-intro', 0.8);
    }

    function tossCoin() {
        const res = document.getElementById('coin-result');
        res.innerText = "Girando...";
        playSnd('snd-tick', 0.5);
        setTimeout(() => {
            const lado = Math.random() > 0.5 ? "CARA" : "CRUZ";
            res.innerText = "ü™ô " + lado;
        }, 1000);
    }

    function setStartingTeam(pIdx) {
        currentP = pIdx;
        document.getElementById('p1-box').classList.toggle('active', pIdx === 0);
        document.getElementById('p2-box').classList.toggle('active', pIdx === 1);
        document.getElementById('coin-setup').style.display = 'none';
        initGame();
    }

    function initGame() {
        const bg = document.getElementById('snd-bg');
        if(bg.src && bg.src.startsWith('data:')) { 
            bg.volume = document.getElementById('bg-volume').value; 
            bg.play().catch(e => console.log("Play blocked"));
        }
        
        game = document.getElementById('input-data').value.trim().split(/\n\s*\n/).map(b => {
            const lines = b.trim().split('\n');
            return { q: lines[0], a: lines.slice(1) };
        });
        
        document.getElementById('btn-config-toggle').style.display = 'block';
        document.getElementById('btn-error').style.display = 'block';
        round = 0; 
        loadRound();
    }

    function loadRound() {
        if(round >= game.length) { showWinner(); return; }
        document.getElementById('round-number').innerText = `RONDA ${round + 1} DE ${game.length}`;
        const data = game[round];
        document.getElementById('q-display').innerText = data.q.toUpperCase();
        document.getElementById('next-btn').style.display = 'none';
        const b = document.getElementById('board');
        b.innerHTML = "";
        resetX();
        startTimer();

        data.a.forEach(line => {
            const parts = line.split(',');
            if(parts.length < 2) return;
            const txt = parts[0];
            const pts = parts[1];
            
            const div = document.createElement('div');
            div.className = "answer hidden";
            div.innerHTML = `<span>${txt.trim().toUpperCase()}</span><strong style="color:var(--oro)">${pts}</strong>`;
            div.onclick = function() {
                if(this.classList.contains('hidden')) {
                    this.classList.replace('hidden', 'revealed');
                    playSnd('snd-correct', 0.8);
                    points[currentP] += parseInt(pts);
                    document.getElementById(`score-${currentP}`).innerText = points[currentP].toString().padStart(3, '0');
                    if(document.querySelectorAll('.board .hidden').length === 0) {
                        clearInterval(timerObj);
                        playSnd('snd-endround', 0.8);
                        document.getElementById('next-btn').style.display = 'block';
                    } else { startTimer(); }
                }
            };
            b.appendChild(div);
        });
    }

    function startTimer() {
        clearInterval(timerObj);
        let time = 20;
        document.getElementById('timer-val').innerText = time;
        timerObj = setInterval(() => {
            time--;
            document.getElementById('timer-val').innerText = time;
            if(time > 0) playSnd('snd-tick', 0.4);
            if(time <= 0) {
                clearInterval(timerObj);
                handleError();
            }
        }, 1000);
    }

    function handleError() {
        playSnd('snd-wrong', 0.9);
        const marks = document.querySelectorAll('.x-mark');
        if(errors < 3) {
            marks[errors].classList.add('x-active');
            errors++;
            if(errors === 3) {
                clearInterval(timerObj);
                setTimeout(() => {
                    currentP = (currentP === 0) ? 1 : 0;
                    resetX();
                    document.getElementById('p1-box').classList.toggle('active');
                    document.getElementById('p2-box').classList.toggle('active');
                    startTimer();
                }, 1500);
            } else {
                startTimer();
            }
        }
    }

    function resetX() {
        errors = 0;
        document.querySelectorAll('.x-mark').forEach(x => x.classList.remove('x-active'));
    }

    function nextRound() { round++; loadRound(); }

    function playSnd(id, vol = 0.5) {
        const audio = document.getElementById(id);
        if (audio && audio.src && audio.src.startsWith('data:')) {
            audio.volume = vol;
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Audio play blocked"));
        }
    }

    function showWinner() {
        document.getElementById('snd-bg').pause();
        playSnd('snd-win', 1.0);
        const winIdx = points[0] > points[1] ? 0 : 1;
        const banner = document.getElementById('winner-team-name');
        banner.innerText = winIdx === 0 ? "¬°EQUIPO AZUL!" : "¬°EQUIPO ROJO!";
        banner.style.color = winIdx === 0 ? "#4aa3ff" : "#ff4d4d";
        document.getElementById('final-score').innerText = Math.max(points[0], points[1]) + " PUNTOS";
        document.getElementById('winner-screen').style.display = 'flex';
    }

    function toggleConfig() {
        const panel = document.getElementById('setup-panel');
        if (panel.style.display === 'none') {
            clearInterval(timerObj);
            document.getElementById('snd-bg').pause();
            panel.style.display = 'block';
            document.getElementById('btn-error').style.display = 'none';
        } else {
            panel.style.display = 'none';
            document.getElementById('btn-error').style.display = 'block';
        }
    }
</script>
</body>
</html>
